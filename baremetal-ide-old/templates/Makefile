#################################
# Project Settings
#################################

# generated by baremetal-ide version {{ ide_version }}

TARGET ?= {{ target }}

CHIP ?= {{ chipname }}

#################################
# RISCV Toolchain
#################################

PREFIX = {{ toolchain_prefix }}

CC = $(PREFIX)gcc
CXX = $(PREFIX)g++
CP = $(PREFIX)objcopy
OD = $(PREFIX)objdump
DG = $(PREFIX)gdb
SIZE = $(PREFIX)size


#################################
# Working directories
#################################
BSP_DIR = bsp/
LIB_DIR = lib/
USR_DIR = core/

LIB_SRC_DIR = $(LIB_DIR)src/
LIB_INC_DIR = $(LIB_DIR)inc/
SRC_DIR = $(USR_DIR)src/
INC_DIR = $(USR_DIR)inc/

BUILD_DIR = build/


#################################
# Source Files
#################################
A_SOURCES  = $(wildcard $(SRC_DIR)*.S) $(wildcard $(SRC_DIR)*/*.S)
A_SOURCES += $(wildcard $(LIB_SRC_DIR)*.S) $(wildcard $(LIB_SRC_DIR)*/*.S)

C_SOURCES  = $(wildcard $(SRC_DIR)*.c) $(wildcard $(SRC_DIR)*/*.c)
C_SOURCES += $(wildcard $(LIB_SRC_DIR)*.S) $(wildcard $(LIB_SRC_DIR)*/*.S)

A_SOURCES += $(BSP_DIR)$(CHIP)/startup/$(CHIP)_bootrom.S
A_SOURCES += $(BSP_DIR)$(CHIP)/startup/$(CHIP)_startup.S

{{ sourcefile_c_sources }}

INCLUDES  = -I$(INC_DIR)
INCLUDES += -I$(LIB_INC_DIR)
INCLUDES += -I$(INC_DIR)hal/
INCLUDES += -I$(BSP_DIR)$(CHIP)/inc


#################################
# Object List
#################################
A_OBJECTS = $(addsuffix .o,$(addprefix $(BUILD_DIR),$(basename $(A_SOURCES))))
C_OBJECTS = $(addsuffix .o,$(addprefix $(BUILD_DIR),$(basename $(C_SOURCES))))

OBJECTS = $(A_OBJECTS) $(C_OBJECTS)

#################################
# Target Output Files
#################################
TARGET_ELF = $(BUILD_DIR)$(TARGET).elf
TARGET_BIN = $(BUILD_DIR)$(TARGET).bin
TARGET_HEX = $(BUILD_DIR)$(TARGET).hex
TARGET_VERILOG = $(BUILD_DIR)$(TARGET).out


#################################
# Flags
#################################

# MCU Settings
ARCH = {{ flag_arch }}
ABI = {{ flag_abi }}
CODEMODEL = {{ flag_codemodel }}
LD_SCRIPT = $(BSP_DIR)$(CHIP)/$(CHIP).ld

ARCHFLAGS = -march=$(ARCH) -mabi=$(ABI) -mcmodel=$(CODEMODEL) -fno-pie
SPECFLAGS = --specs="nano.specs"

# compiler Flags
CFLAGS  = -g -std=gnu11 -Os -Wall -Wextra -Warray-bounds -Wno-unused-parameter
CFLAGS += -fno-common -fno-builtin-printf
CFLAGS += $(ARCHFLAGS)
CFLAGS += $(SPECFLAGS)
CFLAGS += $(INCLUDES)

# linker Flags
LFLAGS  = -static
# LFLAGS += -nostartfiles -nostdlib
LFLAGS += -nostartfiles
LFLAGS += -ffunction-sections
LFLAGS += -fdata-sections
LFLAGS += -T $(LD_SCRIPT)


#################################
# Build
#################################

# default target
all: $(TARGET_ELF)

$(TARGET_BIN): $(TARGET_ELF)
	$(CP) -O binary $< $@

$(TARGET_HEX): $(TARGET_ELF)
	$(CP) -O ihex $< $@

$(TARGET_VERILOG): $(TARGET_ELF)
	$(CP) -O verilog $< $@

$(TARGET_ELF): $(OBJECTS)
	@echo "[LD] linking $@"
	@$(CC) $(CFLAGS) $(LFLAGS) $^ -o $@
	$(SIZE) $(TARGET_ELF)

$(A_OBJECTS): $(BUILD_DIR)%.o: %.S
	@echo "[CC] compiling $@"
	@mkdir -p $(@D)
	@$(CC) $(CFLAGS) -c $< -o $@

$(C_OBJECTS): $(BUILD_DIR)%.o: %.c
	@echo "[CC] compiling $@"
	@mkdir -p $(@D)
	@$(CC) $(CFLAGS) -c $< -o $@


#################################
# Recipes
#################################

clean:
	@rm -rf $(BUILD_DIR)

bin: $(TARGET_BIN)

hex: $(TARGET_HEX)

verilog: $(TARGET_VERILOG)

# openocd currently only supports 32 bit target, thus we need to use binary loader
upload: $(TARGET_BIN)
	@openocd -f ./debug/bearlyml.cfg -c "program $(TARGET_BIN) 0x20000000 reset exit"

dump:
	$(OD) -d $(TARGET_ELF)

